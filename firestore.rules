rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper: ownership via a userId field on the document
    function ownsDocByUserIdField() {
      return isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    function createsDocWithOwnUserIdField() {
      return (
        isAuthenticated() &&
        request.resource.data.userId == request.auth.uid
      );
    }

    // Prevent changing ownership on update
    function keepsSameUserId() {
      return request.resource.data.userId == resource.data.userId;
    }
    
    // Goals collection - users can only read/write their own goals
    match /goals/{goalId} {
      allow read: if ownsDocByUserIdField();
      allow create: if createsDocWithOwnUserIdField();
      allow update: if ownsDocByUserIdField() && keepsSameUserId();
      allow delete: if ownsDocByUserIdField();
    }
    
    // Habits collection - users can only read/write their own habits
    match /habits/{habitId} {
      allow read: if ownsDocByUserIdField();
      allow create: if createsDocWithOwnUserIdField();
      allow update: if ownsDocByUserIdField() && keepsSameUserId();
      allow delete: if ownsDocByUserIdField();
    }
    
    // Users collection - app queries by resource.data.userId (not doc id)
    match /users/{docId} {
      // Store user profile/preferences at docId == auth uid.
      allow read: if isAuthenticated() && docId == request.auth.uid;
      allow create: if isAuthenticated() && docId == request.auth.uid;
      allow update: if isAuthenticated() && docId == request.auth.uid;
      allow delete: if isAuthenticated() && docId == request.auth.uid;
    }

    // Daily logs are stored as a subcollection under the user doc:
    // /users/{uid}/dailyLogs/{dateKey}
    match /users/{userId}/dailyLogs/{dateKey} {
      allow read, create, update, delete: if isAuthenticated() && userId == request.auth.uid;
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

